blueprint:
  name: Light/Switch Scheduler
  description: >
    Turn one or more lights or switches on/off at set times or around sunrise/sunset,
    with dropdown action/offset selection and active days of the week.
  domain: automation
  input:
    target_entities:
      name: Lights or Switches
      selector:
        entity:
          multiple: true
          domain:
            - light
            - switch

    turn_on_time:
      name: Turn ON Time
      description: "**OPTIONAL:** Fixed time to turn on"
      default: ""
      selector:
        time:

    turn_off_time:
      name: Turn OFF Time
      description: "**OPTIONAL:** Fixed time to turn off"
      default: ""
      selector:
        time:

    sunrise_option:
      name: Sunrise Trigger
      description: Choose what happens relative to sunrise
      default: "disabled"
      selector:
        select:
          options:
            - label: "Turn ON 15 minutes before sunrise"
              value: "on_-00:15:00"
            - label: "Turn ON at sunrise"
              value: "on_00:00:00"
            - label: "Turn ON 15 minutes after sunrise"
              value: "on_+00:15:00"
            - label: "Disabled"
              value: "disabled"
            - label: "Turn OFF 15 minutes before sunrise"
              value: "off_-00:15:00"
            - label: "Turn OFF at sunrise"
              value: "off_00:00:00"
            - label: "Turn OFF 15 minutes after sunrise"
              value: "off_+00:15:00"

    sunset_option:
      name: Sunset Trigger
      description: Choose what happens relative to sunset
      default: "disabled"
      selector:
        select:
          options:
            - label: "Turn ON 15 minutes before sunset"
              value: "on_-00:15:00"
            - label: "Turn ON at sunset"
              value: "on_00:00:00"
            - label: "Turn ON 15 minutes after sunset"
              value: "on_+00:15:00"
            - label: "Disabled"
              value: "disabled"
            - label: "Turn OFF 15 minutes before sunset"
              value: "off_-00:15:00"
            - label: "Turn OFF at sunset"
              value: "off_00:00:00"
            - label: "Turn OFF 15 minutes after sunset"
              value: "off_+00:15:00"

    active_days:
      name: Active Days
      description: Days of the week when this automation should run
      default:
        - mon
        - tue
        - wed
        - thu
        - fri
        - sat
        - sun
      selector:
        select:
          multiple: true
          mode: list
          options:
            - label: "Monday"
              value: mon
            - label: "Tuesday"
              value: tue
            - label: "Wednesday"
              value: wed
            - label: "Thursday"
              value: thu
            - label: "Friday"
              value: fri
            - label: "Saturday"
              value: sat
            - label: "Sunday"
              value: sun

mode: single

trigger:
  - platform: time
    at: !input turn_on_time
    id: time_on
  - platform: time
    at: !input turn_off_time
    id: time_off
  - platform: sun
    event: sunrise
    offset: "{{ (!input sunrise_option).split('_')[1] if !input sunrise_option != 'disabled' else '00:00:00' }}"
    id: sunrise
  - platform: sun
    event: sunset
    offset: "{{ (!input sunset_option).split('_')[1] if !input sunset_option != 'disabled' else '00:00:00' }}"
    id: sunset

condition:
  # Restrict to selected days
  - condition: template
    value_template: >
      {{ now().strftime('%a')|lower[0:3] in (!input active_days) }}

  # Skip disabled sun options
  - condition: or
    conditions:
      - condition: template
        value_template: "{{ trigger.id in ['time_on', 'time_off'] }}"
      - condition: template
        value_template: "{{ trigger.id == 'sunrise' and !input sunrise_option != 'disabled' }}"
      - condition: template
        value_template: "{{ trigger.id == 'sunset' and !input sunset_option != 'disabled' }}"

action:
  - choose:
      - conditions:
          - condition: trigger
            id: time_on
        sequence:
          - service: homeassistant.turn_on
            target:
              entity_id: !input target_entities

      - conditions:
          - condition: trigger
            id: time_off
        sequence:
          - service: homeassistant.turn_off
            target:
              entity_id: !input target_entities

      - conditions:
          - condition: trigger
            id: sunrise
          - condition: template
            value_template: "{{ (!input sunrise_option).startswith('on_') }}"
        sequence:
          - service: homeassistant.turn_on
            target:
              entity_id: !input target_entities

      - conditions:
          - condition: trigger
            id: sunrise
          - condition: template
            value_template: "{{ (!input sunrise_option).startswith('off_') }}"
        sequence:
          - service: homeassistant.turn_off
            target:
              entity_id: !input target_entities

      - conditions:
          - condition: trigger
            id: sunset
          - condition: template
            value_template: "{{ (!input sunset_option).startswith('on_') }}"
        sequence:
          - service: homeassistant.turn_on
            target:
              entity_id: !input target_entities

      - conditions:
          - condition: trigger
            id: sunset
          - condition: template
            value_template: "{{ (!input sunset_option).startswith('off_') }}"
        sequence:
          - service: homeassistant.turn_off
            target:
              entity_id: !input target_entities
