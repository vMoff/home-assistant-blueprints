blueprint:
  name: Light/Switch Scheduler
  description: >
    V1 Turn a light or switch on/off at set times or around sunrise/sunset,
    with dropdown offset selection and active days of the week.
  domain: automation
  input:
    target_entity:
      name: Light or Switch
      selector:
        entity:
          domain:
            - light
            - switch

    turn_on_time:
      name: Turn ON Time
      description: Optional fixed time to turn on
      default: ""
      selector:
        time:

    turn_off_time:
      name: Turn OFF Time
      description: Optional fixed time to turn off
      default: ""
      selector:
        time:

    sunrise_option:
      name: Sunrise Trigger
      description: Choose when to turn OFF relative to sunrise
      default: "off"
      selector:
        select:
          options:
            - label: "Off"
              value: "off"
            - label: "15 minutes before sunrise"
              value: "-00:15:00"
            - label: "At sunrise"
              value: "00:00:00"
            - label: "15 minutes after sunrise"
              value: "+00:15:00"

    sunset_option:
      name: Sunset Trigger
      description: Choose when to turn ON relative to sunset
      default: "off"
      selector:
        select:
          options:
            - label: "Off"
              value: "off"
            - label: "15 minutes before sunset"
              value: "-00:15:00"
            - label: "At sunset"
              value: "00:00:00"
            - label: "15 minutes after sunset"
              value: "+00:15:00"

    active_days:
      name: Active Days
      description: Days of the week when this automation should run
      default:
        - mon
        - tue
        - wed
        - thu
        - fri
        - sat
        - sun
      selector:
        select:
          multiple: true
          mode: list
          options:
            - label: "Monday"
              value: mon
            - label: "Tuesday"
              value: tue
            - label: "Wednesday"
              value: wed
            - label: "Thursday"
              value: thu
            - label: "Friday"
              value: fri
            - label: "Saturday"
              value: sat
            - label: "Sunday"
              value: sun

mode: single

trigger:
  - platform: time
    at: !input turn_on_time
    id: time_on
  - platform: time
    at: !input turn_off_time
    id: time_off
  - platform: sun
    event: sunrise
    offset: !input sunrise_option
    id: sunrise
  - platform: sun
    event: sunset
    offset: !input sunset_option
    id: sunset

condition:
  # Restrict to selected days
  - condition: template
    value_template: >
      {{ now().strftime('%a')|lower[0:3] in (!input active_days) }}

  # Skip if sunrise/sunset set to "off"
  - condition: or
    conditions:
      - condition: template
        value_template: "{{ trigger.id in ['time_on', 'time_off'] }}"
      - condition: template
        value_template: "{{ trigger.id == 'sunrise' and !input sunrise_option != 'off' }}"
      - condition: template
        value_template: "{{ trigger.id == 'sunset' and !input sunset_option != 'off' }}"

action:
  - choose:
      - conditions:
          - condition: trigger
            id: time_on
        sequence:
          - service: homeassistant.turn_on
            target:
              entity_id: !input target_entity
      - conditions:
          - condition: trigger
            id: time_off
        sequence:
          - service: homeassistant.turn_off
            target:
              entity_id: !input target_entity
      - conditions:
          - condition: trigger
            id: sunset
        sequence:
          - service: homeassistant.turn_on
            target:
              entity_id: !input target_entity
      - conditions:
          - condition: trigger
            id: sunrise
        sequence:
          - service: homeassistant.turn_off
            target:
              entity_id: !input target_entity
